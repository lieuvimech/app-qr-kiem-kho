<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App ki·ªÉm kho QR</title>

  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;text-align:center;color:#111}
    h1{font-size:18px;margin:8px 0}
    #reader{width:100%;max-width:420px;margin:12px auto;border-radius:8px;overflow:hidden;background:#000}
    #ui{margin-top:12px}
    #qtyBox{display:none;margin-top:10px}
    input[type="number"]{padding:8px;font-size:16px;width:160px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 12px;font-size:15px;border-radius:6px;border:0;background:#1976d2;color:#fff;margin-left:8px}
    #status{margin-top:12px;min-height:20px}
    #debug{white-space:pre-wrap;text-align:left;background:#f2f4f7;border-radius:6px;padding:8px;margin:12px auto;max-width:720px;overflow:auto;font-size:13px;color:#333}
    #controls{margin-top:16px}
    label{font-size:15px}
  </style>
</head>
<body>
  <h1>üì¶ App ki·ªÉm kho QR</h1>

  <div id="reader"></div>

  <div id="ui">
    <div id="msg">S·∫µn s√†ng qu√©t m√£...</div>

    <div id="qtyBox">
      <p>M√£ v·∫≠t t∆∞: <b id="scanned"></b></p>
      <input id="qty" type="number" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng (m·∫∑c ƒë·ªãnh = 1)" min="1" />
      <button id="sendBtn">G·ª≠i</button>
    </div>
  </div>

  <div id="status"></div>

  <div id="controls">
    <label>
      <input type="checkbox" id="togglePos" checked />
      B·∫≠t qu√©t v·ªã tr√≠ (ENABLE_SCAN_POSITION)
    </label>
  </div>

  <!-- Debug log -->
  <div id="debug"></div>

<script>
/* =========== C·∫§U H√åNH =========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-HxqBU2XYaTofTloPQKoVFWa0jvOsnIk_eSU69R2NHaZVaNVyWjV8le6ZTuTdBcY_/exec";
const SHEET_NAME = "Scan QR ki·ªÉm kho";
/* ================================= */

let html5QrCode = null;
let currentCameraId = null;
let expectPosition = false;
let lastMaterial = null;
let enableScanPosition = true;

const readerId = "reader";
const msgEl = document.getElementById("msg");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");
const qtyBox = document.getElementById("qtyBox");
const scannedEl = document.getElementById("scanned");
const qtyInput = document.getElementById("qty");
const sendBtn = document.getElementById("sendBtn");
const togglePos = document.getElementById("togglePos");

function logDebug(s){
  console.log(s);
  debugEl.textContent += s + "\n";
  debugEl.scrollTop = debugEl.scrollHeight;
}
function setStatus(s){
  statusEl.textContent = s;
  logDebug(s);
}

/* Kh·ªüi ƒë·ªông scanner */
async function startScanner(){
  try{
    if(!html5QrCode) html5QrCode = new Html5Qrcode(readerId);
    const cams = await Html5Qrcode.getCameras();
    logDebug("Cameras found: " + (cams ? cams.length : 0));
    if(cams && cams.length){
      const cam = cams[cams.length - 1];
      currentCameraId = cam.id;
      logDebug("Using camera: " + (cam.label || cam.id));
      await html5QrCode.start(
        { deviceId: { exact: currentCameraId } },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      );
      setStatus("üöÄ ƒêang qu√©t ‚Äî h∆∞·ªõng camera t·ªõi QR");
    } else {
      setStatus("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y camera");
    }
  }catch(err){
    setStatus("‚ùå L·ªói kh·ªüi ƒë·ªông camera: " + err);
  }
}
async function stopScanner(){
  try{
    if(html5QrCode) await html5QrCode.stop();
    document.getElementById(readerId).innerHTML = "";
    setStatus("Camera t·∫°m d·ª´ng");
  }catch(e){ logDebug("stopScanner error: " + e); }
}

function onScanSuccess(decodedText){
  if(expectPosition){
    setStatus("üìç ƒê√£ qu√©t v·ªã tr√≠: " + decodedText);
    sendPayload({ qr_text: decodedText, isPosition: true })
      .then(()=> {
        setStatus("‚úÖ V·ªã tr√≠ ƒë√£ g·ª≠i, quay l·∫°i qu√©t v·∫≠t t∆∞");
        expectPosition = false;
        restartScanner();
      }).catch(err=>{
        setStatus("‚ùå L·ªói g·ª≠i v·ªã tr√≠: " + err);
        restartScanner();
      });
    return;
  }

  lastMaterial = decodedText;
  scannedEl.textContent = decodedText;
  qtyInput.value = "";
  qtyBox.style.display = "block";
  setStatus("M√£ v·∫≠t t∆∞ ƒë√£ qu√©t ‚Äî nh·∫≠p s·ªë l∆∞·ª£ng r·ªìi nh·∫•n G·ª≠i");
  stopScanner();
}
function onScanFailure(error){}

async function sendPayload(payload){
  payload.sheetName = SHEET_NAME;
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("HTTP " + res.status + " " + txt);
  }
  return res.text().catch(()=> "OK");
}

sendBtn.addEventListener("click", async ()=>{
  let qty = qtyInput.value;
  if(!qty || qty.trim()==="") qty=1;
  qty = Number(qty)||1;

  setStatus("‚è≥ G·ª≠i v·∫≠t t∆∞: " + lastMaterial + " | SL: " + qty);
  try{
    await sendPayload({ qr_text: lastMaterial, qty: qty });
    setStatus("‚úÖ ƒê√£ g·ª≠i v·∫≠t t∆∞: " + lastMaterial + " | SL: " + qty);
  }catch(err){
    setStatus("‚ùå L·ªói g·ª≠i v·∫≠t t∆∞: " + err);
    qtyBox.style.display = "none";
    restartScanner();
    return;
  }
  qtyBox.style.display = "none";

  if(enableScanPosition){
    expectPosition = true;
    setStatus("Vui l√≤ng qu√©t m√£ v·ªã tr√≠...");
    restartScanner();
  } else {
    setStatus("S·∫µn s√†ng qu√©t ti·∫øp");
    restartScanner();
  }
});

function restartScanner(){
  try{ if(html5QrCode) html5QrCode.stop().catch(()=>{});}catch(e){}
  setTimeout(()=> startScanner(), 400);
}

/* Toggle checkbox */
togglePos.addEventListener("change", ()=>{
  enableScanPosition = togglePos.checked;
  logDebug("ENABLE_SCAN_POSITION = " + enableScanPosition);
});

/* Start khi load */
window.addEventListener("load", ()=>{
  setStatus("Trang ƒë√£ load ‚Äî kh·ªüi t·∫°o scanner...");
  enableScanPosition = togglePos.checked;
  startScanner();
});
</script>
</body>
</html>
