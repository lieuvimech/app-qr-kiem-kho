<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App kiá»ƒm kho QR</title>

  <!-- ThÆ° viá»‡n (jsDelivr á»•n Ä‘á»‹nh) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;text-align:center;color:#111}
    h1{font-size:18px;margin:8px 0}
    #reader{width:100%;max-width:420px;margin:12px auto;border-radius:8px;overflow:hidden;background:#000}
    #ui{margin-top:12px}
    #qtyBox{display:none;margin-top:10px}
    input[type="number"]{padding:8px;font-size:16px;width:160px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 12px;font-size:15px;border-radius:6px;border:0;background:#1976d2;color:#fff;margin-left:8px}
    #status{margin-top:12px;min-height:20px}
    #debug{white-space:pre-wrap;text-align:left;background:#f2f4f7;border-radius:6px;padding:8px;margin:12px auto;max-width:720px;overflow:auto;font-size:13px;color:#333}
  </style>
</head>
<body>
  <h1>ðŸ“¦ App kiá»ƒm kho QR</h1>

  <div id="reader"></div>

  <div id="ui">
    <div id="msg">Sáºµn sÃ ng quÃ©t mÃ£...</div>

    <div id="qtyBox">
      <p>MÃ£ váº­t tÆ°: <b id="scanned"></b></p>
      <input id="qty" type="number" placeholder="Nháº­p sá»‘ lÆ°á»£ng (máº·c Ä‘á»‹nh = 1)" min="1" />
      <button id="sendBtn">Gá»­i</button>
    </div>
  </div>

  <div id="status"></div>

  <!-- Debug (áº©n náº¿u khÃ´ng cáº§n) -->
  <div id="debug" style="display:none"></div>

<script>
/* =========== Cáº¤U HÃŒNH =========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-HxqBU2XYaTofTloPQKoVFWa0jvOsnIk_eSU69R2NHaZVaNVyWjV8le6ZTuTdBcY_/exec";
const ENABLE_SCAN_POSITION = true; // true náº¿u báº­t cháº¿ Ä‘á»™ quÃ©t vá»‹ trÃ­
/* ================================= */

let html5QrCode = null;
let currentCameraId = null;
let expectPosition = false;  // true = láº§n quÃ©t tiáº¿p theo lÃ  vá»‹ trÃ­
let lastMaterial = null;

const readerId = "reader";
const msgEl = document.getElementById("msg");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");
const qtyBox = document.getElementById("qtyBox");
const scannedEl = document.getElementById("scanned");
const qtyInput = document.getElementById("qty");
const sendBtn = document.getElementById("sendBtn");

function logDebug(s){
  console.log(s);
  // báº­t dÃ²ng dÆ°á»›i náº¿u muá»‘n hiá»ƒn debug trÃªn trang
  // debugEl.style.display = "block"; debugEl.textContent += s + "\n";
}

/* Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ngáº¯n */
function setStatus(s){
  statusEl.textContent = s;
  logDebug(s);
}

/* Khá»Ÿi Ä‘á»™ng scanner, cá»‘ chá»n camera sau náº¿u cÃ³ */
async function startScanner(){
  try{
    if(!html5QrCode) html5QrCode = new Html5Qrcode(readerId);
    // láº¥y danh sÃ¡ch camera
    const cams = await Html5Qrcode.getCameras();
    logDebug("Cameras found: " + (cams ? cams.length : 0));
    if(cams && cams.length){
      // chá»n camera cuá»‘i (thÆ°á»ng lÃ  camera sau trÃªn nhiá»u thiáº¿t bá»‹)
      const cam = cams[cams.length - 1];
      currentCameraId = cam.id;
      logDebug("Using camera: " + (cam.label || cam.id));
      await html5QrCode.start(
        { deviceId: { exact: currentCameraId } },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      );
      setStatus("ðŸš€ Äang quÃ©t â€” hÆ°á»›ng camera tá»›i QR");
    } else {
      setStatus("âš ï¸ KhÃ´ng tÃ¬m tháº¥y camera trÃªn thiáº¿t bá»‹");
    }
  }catch(err){
    setStatus("âŒ Lá»—i khi khá»Ÿi Ä‘á»™ng camera: " + (err && err.message ? err.message : err));
    logDebug("startScanner error: " + err);
  }
}

/* Dá»«ng scanner an toÃ n */
async function stopScanner(){
  try{
    if(html5QrCode && html5QrCode.getState && html5QrCode.getState() !== Html5QrcodeScannerState.NOT_STARTED){
      // html5QrCode.stop exists
    }
    if(html5QrCode) await html5QrCode.stop();
    // clear camera preview element (giáº£i phÃ³ng)
    try{ document.getElementById(readerId).innerHTML = ""; }catch(e){}
    setStatus("Camera táº¡m dá»«ng");
  }catch(e){
    logDebug("stopScanner error: " + e);
  }
}

/* Scan thÃ nh cÃ´ng */
function onScanSuccess(decodedText, decodedResult){
  // náº¿u Ä‘ang chá» vá»‹ trÃ­ => gá»­i vá»‹ trÃ­
  if(expectPosition){
    setStatus("ðŸ“ ÄÃ£ quÃ©t vá»‹ trÃ­: " + decodedText + " â€” gá»­i lÃªn sheet...");
    // gá»­i isPosition
    sendPayload({ qr_text: decodedText, isPosition: true })
      .then(()=> {
        setStatus("âœ… Vá»‹ trÃ­ Ä‘Ã£ gá»­i. Quay láº¡i quÃ©t váº­t tÆ°...");
        expectPosition = false;
        // tiáº¿p tá»¥c quÃ©t
        restartScanner();
      }).catch(err => {
        setStatus("âŒ Lá»—i gá»­i vá»‹ trÃ­: " + err);
        restartScanner();
      });
    return;
  }

  // náº¿u khÃ´ng chá» vá»‹ trÃ­ => Ä‘Ã¢y lÃ  váº­t tÆ°: dá»«ng camera, show input qty
  lastMaterial = decodedText;
  scannedEl.textContent = decodedText;
  qtyInput.value = "";
  qtyBox.style.display = "block";
  setStatus("MÃ£ váº­t tÆ° Ä‘Ã£ quÃ©t â€” nháº­p sá»‘ lÆ°á»£ng rá»“i nháº¥n Gá»­i (máº·c Ä‘á»‹nh=1)");
  // dá»«ng camera Ä‘á»ƒ ngÆ°á»i dÃ¹ng nháº­p
  // html5QrCode.pause() khÃ´ng cÃ³, dÃ¹ng stop() vÃ  sau Ä‘Ã³ sáº½ render láº¡i startScanner
  stopScanner();
}

/* Scan tháº¥t báº¡i (bá» qua) */
function onScanFailure(error){
  // khÃ´ng log chi tiáº¿t Ä‘á»ƒ trÃ¡nh spam
}

/* Gá»­i payload lÃªn Apps Script */
async function sendPayload(payload){
  // thÃªm sheetName náº¿u muá»‘n (Apps Script cá»§a báº¡n Ä‘ang dÃ¹ng TARGET_SHEET cá»‘ Ä‘á»‹nh)
  // payload.sheetName = "Scan QR kiá»ƒm kho";
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>"");
    throw new Error("HTTP " + res.status + " " + txt);
  }
  return res.text().catch(()=>"OK");
}

/* Xá»­ lÃ½ nÃºt Gá»­i */
sendBtn.addEventListener("click", async ()=> {
  let qty = qtyInput.value;
  if(!qty || qty.toString().trim() === "") qty = 1;
  qty = Number(qty) || 1;

  // gá»­i váº­t tÆ° + qty
  setStatus("â³ Äang gá»­i mÃ£ váº­t tÆ°: " + lastMaterial + " | SL: " + qty);
  try{
    await sendPayload({ qr_text: lastMaterial, qty: qty });
    setStatus("âœ… ÄÃ£ gá»­i mÃ£ váº­t tÆ°: " + lastMaterial + " | SL: " + qty);
  }catch(err){
    setStatus("âŒ Lá»—i gá»­i mÃ£ váº­t tÆ°: " + err);
    // khá»Ÿi Ä‘á»™ng láº¡i scanner Ä‘á»ƒ thá»­ láº¡i
    qtyBox.style.display = "none";
    restartScanner();
    return;
  }

  qtyBox.style.display = "none";

  if(ENABLE_SCAN_POSITION){
    expectPosition = true;
    setStatus("Vui lÃ²ng quÃ©t mÃ£ vá»‹ trÃ­ (láº§n quÃ©t káº¿ tiáº¿p sáº½ lÃ  vá»‹ trÃ­).");
    // khá»Ÿi Ä‘á»™ng láº¡i scanner Ä‘á»ƒ chá» vá»‹ trÃ­
    restartScanner();
  } else {
    setStatus("Sáºµn sÃ ng quÃ©t tiáº¿p.");
    restartScanner();
  }
});

/* Restart scanner (dá»«ng sáº¡ch vÃ  start láº¡i sau delay) */
function restartScanner(){
  // clear preview element (Html5Qrcode.start will recreate video)
  try{ if(html5QrCode) html5QrCode.stop().catch(()=>{}); }catch(e){}
  // small delay to ensure camera is freed
  setTimeout(()=> startScanner(), 400);
}

/* Start when page loaded */
window.addEventListener("load", () => {
  setStatus("Trang Ä‘Ã£ load â€” khá»Ÿi táº¡o scanner...");
  startScanner();
});
</script>
</body>
</html>
