<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Scan QR ki·ªÉm kho</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    #debug { white-space: pre-wrap; border: 1px solid #ccc; padding: 6px; margin-top: 10px; font-size: 13px; height: 200px; overflow-y: auto; background: #f9f9f9; }
    button { margin: 5px 0; padding: 6px 12px; }
  </style>
</head>
<body>
  <h3>üì¶ Scan QR ki·ªÉm kho</h3>
  <div id="reader"></div>

  <button id="togglePos">B·∫≠t/T·∫Øt qu√©t v·ªã tr√≠ (ENABLE_SCAN_POSITION)</button>

  <div id="debug"></div>

  <script>
    // === C·∫•u h√¨nh ===
    let ENABLE_SCAN_POSITION = true;
    const SHEET_NAME = "Scan QR ki·ªÉm kho";  // Sheet b·∫°n mu·ªën
    const SCRIPT_URL = "YOUR_APPS_SCRIPT_DEPLOYMENT_URL"; // ‚ö†Ô∏è ƒê·ªïi URL Apps Script

    // === Debug helper ===
    function logDebug(msg) {
      const dbg = document.getElementById("debug");
      dbg.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      dbg.scrollTop = dbg.scrollHeight;
      console.log(msg);
    }

    // === Toggle button ===
    document.getElementById("togglePos").onclick = () => {
      ENABLE_SCAN_POSITION = !ENABLE_SCAN_POSITION;
      logDebug("ENABLE_SCAN_POSITION = " + ENABLE_SCAN_POSITION);
      alert("ENABLE_SCAN_POSITION = " + ENABLE_SCAN_POSITION);
    };

    // === G·ª≠i d·ªØ li·ªáu v·ªÅ Google Sheet ===
    async function sendToSheet(qrText, isPosition=false, qty=1) {
      const payload = {
        qr_text: qrText,
        qty: qty,
        isPosition: isPosition,
        sheetName: SHEET_NAME
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const text = await res.text();
        logDebug("G·ª≠i th√†nh c√¥ng: " + JSON.stringify(payload) + " ‚Üí " + text);
      } catch (err) {
        logDebug("‚ùå L·ªói g·ª≠i d·ªØ li·ªáu: " + err);
      }
    }

    // === Callback scan QR ===
    function onScanSuccess(decodedText, decodedResult) {
      logDebug("QR qu√©t ƒë∆∞·ª£c: " + decodedText);

      if (ENABLE_SCAN_POSITION && decodedText.startsWith("POS:")) {
        sendToSheet(decodedText, true);
      } else {
        sendToSheet(decodedText, false, 1);
      }
    }

    function onScanFailure(error) {
      // Kh√¥ng log qu√° nhi·ªÅu
    }

    // === Kh·ªüi t·∫°o camera ===
    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // ∆Øu ti√™n camera sau
          let backCamera = devices.find(d => 
            d.label.toLowerCase().includes("back") || 
            d.label.toLowerCase().includes("rear")
          );
          const cameraId = backCamera ? backCamera.id : devices[0].id;
    
          logDebug("S·ª≠ d·ª•ng camera: " + (backCamera ? backCamera.label : devices[0].label));
    
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
          ).catch(err => logDebug("‚ùå L·ªói start scanner: " + err));
        } else {
          logDebug("‚ùå Kh√¥ng t√¨m th·∫•y camera n√†o");
        }
      }).catch(err => logDebug("‚ùå L·ªói getCameras: " + err));
    }
    startScanner();
  </script>
</body>
</html>
